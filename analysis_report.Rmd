---
title: "Decision Tree for Environmental Performance Index (EPI) Analysis"
output: html_document
---

```{r setup, include=FALSE}
# This chunk runs all the setup, data loading, and model training in the background.
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# 1. Packages
needed <- c("tidyverse", "caret", "rpart", "rpart.plot")
lapply(needed, require, character.only = TRUE)

# 2. Data Prep & Feature Engineering
input_csv <- "Data/epi2024_data.csv"
data <- read_csv(input_csv, show_col_types = FALSE)
required_cols <- c("BDH", "EPI", "ECS", "FSH", "APO", "AGR")
data <- data %>% select(all_of(required_cols)) %>% drop_na()

# Create EPI classes (our new target variable)
epi_breaks <- quantile(data$EPI, probs = c(0, 0.33, 0.66, 1), na.rm = TRUE)
data <- data %>%
  mutate(EPI_Class = cut(EPI, breaks = epi_breaks,
                         labels = c("Low", "Medium", "High"),
                         include.lowest = TRUE))

# 3. Training & Evaluation
set.seed(123)
train_idx <- createDataPartition(data$EPI_Class, p = 0.8, list = FALSE)
train_set <- data[train_idx, ]
test_set  <- data[-train_idx, ]

ctrl <- trainControl(method = "repeatedcv", number = 5, repeats = 3)
tune_grid <- expand.grid(cp = 0.001) # Force a complex tree

# Train the model to predict EPI_Class using all other variables EXCEPT EPI itself
tree_model <- train(
  EPI_Class ~ . - EPI, data = train_set,
  method = "rpart",
  trControl = ctrl,
  tuneGrid = tune_grid
)

preds <- predict(tree_model, test_set)
conf  <- confusionMatrix(preds, test_set$EPI_Class)
accuracy <- conf$overall["Accuracy"]
```

### Summary: Predicting Environmental Performance (EPI)

This report presents a decision tree model designed to predict a country's **Environmental Performance Index (EPI) Class** (Low, Medium, or High). Instead of using the EPI score directly, the model learns to predict it based on other related factors, such as Biodiversity & Habitat (`BDH`), Ecosystem Services (`ECS`), and Fish Stocks (`FSH`).

This approach reveals the underlying drivers of environmental performance. The model achieves an accuracy of **`r round(accuracy * 100, 2)`%** on the test data.

### Decision Tree Diagram for EPI

The diagram below visualizes the rules the model learned. The variables appearing highest in the tree are the most influential predictors of a country's EPI score.

```{r plot_tree, fig.width=12, fig.height=8}
rpart.plot(tree_model$finalModel, box.palette = "BuGn", shadow.col = "gray", nn = TRUE)
```

---

### Future EPI Predictions

Here, we use the trained model to predict the EPI Class for several hypothetical future scenarios. This demonstrates how the model can be used to assess the potential impact of changes in related environmental areas.

```{r future_scenarios}
# Create hypothetical future data
future_data <- tibble::tribble(
  ~Scenario, ~BDH, ~ECS, ~FSH, ~APO, ~AGR,
  "High Biodiversity & Ecosystem Services", 95.0, 80.0, 70.0, 75.0, 60.0,
  "Poor Fish Stocks & Agriculture Focus", 40.0, 50.0, 25.0, 45.0, 80.0,
  "Balanced Moderate Scenario", 60.0, 65.0, 62.0, 58.0, 55.0,
  "Ecosystem Collapse", 20.0, 15.0, 10.0, 30.0, 40.0,
  "Sustainable Development Leader", 85.0, 90.0, 80.0, 88.0, 75.0
)

# Add a dummy EPI column to match the training data structure
future_data$EPI <- 0

# Predict the EPI Class for our scenarios
future_data$Predicted_EPI_Class <- predict(tree_model, newdata = future_data)

# Display the results, removing the dummy EPI column for a cleaner table
future_data %>% 
  select(-EPI) %>% 
  knitr::kable(caption = "Model Predictions for Future EPI Scenarios")
```

**Interpreting the Predictions:** This predictive simulation reveals the core logic our model has learned from the real-world data. The results underscore a critical principle: strong overall environmental performance is not merely about avoiding negatives, but about achieving excellence in key domains. For instance, a country with thriving biodiversity is predicted to have a 'High' EPI, confirming that foundational ecological health is a primary driver of top-tier status. Conversely, the model's 'Low' prediction for a nation with poor fish stocks—even if it excels elsewhere—demonstrates that critical system failures cannot be easily offset. Perhaps most tellingly, the 'Balanced Moderate Scenario' also results in a 'Low' classification, suggesting that widespread mediocrity is insufficient for a positive rating; the model has learned that escaping the bottom tier requires clear, decisive strengths rather than just an absence of acute weaknesses.
